<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Cadastro de Cliente</title>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <link rel="shortcut icon" type="imagex/png" href="/static/img/open-book.png">
    <link rel='stylesheet' href="/static/login.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="login-container cadastro-container">
        
        <div class="login-form-side">
            <a href="{{ url_for('livro.index') }}" class="back-button">
                <i class="fas fa-arrow-left"></i>
                <span>Voltar</span>
            </a>

            <div class="logo-section">
                <a href="{{ url_for('livro.index') }}" class="logo-link">
                    <div class="logo-icon">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <span class="logo-text">Livraria Entrelinhas</span>
                </a>
            </div>

            <div class="login-card">
                <div class="login-header">
                    <h1>Crie sua conta</h1>
                    <p>Preencha os campos abaixo para fazer parte da nossa livraria.</p>
                </div>

                <form action="{{ url_for('cliente_bp.salvar_cliente') }}" method="POST" class="login-form">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            <div class="message-container">
                                {% for category, message in messages %}
                                    <div class="validation-message {{ category }}">{{ message | safe }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endwith %}

                    <fieldset class="cadastro-fieldset">
                        <legend>Dados Pessoais</legend>
                        <div class="form-group">
                            <label for="nome">Nome Completo: <span class="required">*</span></label>
                            <input type="text" name="nome" id="nome" required autocomplete="name" autofocus>
                        </div>

                        <div class="form-row">
                            <div class="form-column">
                                <label for="data_nasc">Data Nascimento: <span class="required">*</span></label>
                                <input type="date" name="data_nasc" id="data_nasc" required>
                            </div>
                            <div class="form-column">
                                <label for="telefone">Telefone: <span class="required">*</span></label>
                                <input type="tel" name="telefone" id='telefone' required placeholder="(XX) 9XXXX-XXXX"> 
                            </div>
                        </div>

                        <div class="form-group">
                        <label for="email">Email: <span class="required">*</span></label>
                             <input type="email" name="email" id="email" required autocomplete="email">
                            <p id="email-validation-message" class="validation-message"></p>
                        </div>
                    </fieldset>

                    <fieldset class="cadastro-fieldset">
                        <legend>Login</legend>
                            <div class="form-group">
                                <label for="username">Username: <span class="required">*</span></label>
                                <input type="text" name="username" id='username' required autocomplete="username"> 
                            </div>

                        <div class="form-row">
                            <div class="form-column">
                                <label for="senha">Senha: <span class="required">*</span></label>
                                <input type="password" name="senha" id="senha" required minlength="8" autocomplete="new-password">
                            </div>

                            <div class="form-column">
                                <label for="confirmar_senha">Confirme a Senha: <span class="required">*</span></label>
                                <input type="password" name="confirmar_senha" id="confirmar_senha" required minlength="8" autocomplete="new-password">
                                <p id="password-match-message" class="validation-message"></p>
                            </div>
                        </div>
                    </fieldset>

                <button type="submit" class="btn-login">Finalizar Cadastro</button>
            </form>
                <div class="signup-prompt">
                    <p>
                        Já tem uma conta? 
                        <a href="{{ url_for('auth_bp.login') }}">Fazer login</a>
                    </p>
                </div>
            </div>
        </div>

        <div class="illustration-side cadastro-illustration">
            <div class="illustration-content">
                    <img 
                        src="/static/img/reading-book-boy.png" 
                        alt="Pessoa lendo um livro"
                        class="illustration-image"
                    >
            </div>
        </div>
    </div>
    <script>
        const senhaInput = document.getElementById('senha');
        const confirmarSenhaInput = document.getElementById('confirmar_senha');
        const passwordMessage = document.getElementById('password-match-message');

        function checkPasswords() {
            if (senhaInput.value.length > 0 && confirmarSenhaInput.value.length > 0) {
                if (senhaInput.value !== confirmarSenhaInput.value) {
                    passwordMessage.textContent = "As senhas não coincidem!";
                    passwordMessage.classList.add('erro');
                    passwordMessage.classList.remove('sucesso');
                    confirmarSenhaInput.setCustomValidity('Senhas não coincidem');
                } else {
                    passwordMessage.textContent = "Senhas coincidem!";
                    passwordMessage.classList.add('sucesso');
                    passwordMessage.classList.remove('erro');
                    confirmarSenhaInput.setCustomValidity('');
                }
            } else {
                passwordMessage.textContent = "";
                confirmarSenhaInput.setCustomValidity('');
            }
        }
        senhaInput.addEventListener('keyup', checkPasswords);
        confirmarSenhaInput.addEventListener('keyup', checkPasswords);

        const emailInput = document.getElementById('email');
        const emailMessage = document.getElementById('email-validation-message');
        let emailTimeout;

        function validateEmail() {
            const email = emailInput.value;
            emailMessage.textContent = "";
            emailMessage.classList.remove('erro', 'sucesso');
            
            if (!email || !emailInput.checkValidity()) {
                return;
            }
            
            clearTimeout(emailTimeout);
            emailTimeout = setTimeout(() => {
                emailMessage.textContent = "Verificando email...";
                emailMessage.classList.add('loading');

                fetch("{{ url_for('cliente_bp.check_email') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: email })
                })
                .then(response => response.json())
                .then(data => {
                    emailMessage.classList.remove('loading');
                    emailMessage.textContent = "";
                    emailMessage.classList.remove('erro', 'sucesso');

                    if (data.available === false) {
                        emailMessage.textContent = data.message;
                        emailMessage.classList.add('erro');
                        emailInput.setCustomValidity(data.message);
                    } else {
                        emailInput.setCustomValidity('');
                    }
                });
            }, 700);
        }

        emailInput.addEventListener('input', validateEmail);
        document.querySelector('form').addEventListener('submit', function(event) {
            checkPasswords();
        });
    </script>
</body>
</html>