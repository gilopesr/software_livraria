<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Cadastro de Cliente</title>
    <script src="/static/index.js"></script>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <link rel='stylesheet' href='/static/login.css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="login">
  <header class="top-bar">
        <div class="header__logo">
            <a href="{{ url_for('livro.index') }}" style="text-decoration: none; color: inherit;">
                <img src="{{ url_for('static', filename='img/livro_img.png') }}" alt="Logo Livraria">
                <span>Livraria Entrelinhas</span>
            </a>
        </div>
        <a href="{{ url_for('livro.index') }}" class="top-bar-back-link">
             <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </header>
    <main>
      {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flashes">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}
        <form action="{{ url_for('cliente_bp.salvar_cliente') }}" method="POST" class="cadastro-cliente">
            <h2>Cadastro de Cliente</h2>

            <fieldset>
                <legend>Dados Pessoais</legend>
                
                <label for="nome">Nome Completo: <span class="required">*</span></label>
                <input type="text" name="nome" id="nome" required autocomplete="name" autofocus>

                <div class="form-row">
                    <div class="form-column">
                        <label for="data_nasc">Data Nascimento: <span class="required">*</span></label>
                        <input type="date" name="data_nasc" id="data_nasc" required >
                    </div>
                    <div class="form-column">
                        <label for="telefone">Telefone: <span class="required">*</span></label>
                        <input type="tel" name="telefone" id='telefone' required placeholder="(XX) 9XXXX-XXXX"> 
                    </div>
                </div>
                
                <label for="email">Email: <span class="required">*</span></label>
                <input type="email" name="email" id="email" required autocomplete="email">
                <p id="email-validation-message" class="validation-message"></p>

                <label for="endereco">Endereço:</label>
                <input type="text" name="endereco" id="endereco" placeholder="Rua carneiro, 10">

            </fieldset>

            <fieldset>
                <legend>Login</legend>
                
                <label for="username">Username: <span class="required">*</span></label>
                <input type="text" name="username" id='username' required autocomplete="username"> 
                
                <div class="form-row">
                    <div class="form-column">
                        <label for="senha">Senha: <span class="required">*</span></label>
                        <input type="password" name="senha" id="senha" required minlength="8" autocomplete="new-password">
                    </div>
                    <div class="form-column">
                        <label for="confirmar_senha">Confirme a Senha: <span class="required">*</span></label>
                        <input type="password" name="confirmar_senha" id="confirmar_senha" required minlength="8" autocomplete="new-password">
                        <p id="password-match-message" class="validation-message"></p> 
                    </div>
                </div>
                
            </fieldset>
            
            <button type="submit">Finalizar Cadastro</button>

            {% if sucesso %}
              <script>
                document.addEventListener("DOMContentLoaded", function() {
                  if (confirm("{{ mensagem }}")) {
                    window.location.href = "{{ url_for('cliente_bp.login') }}";
                  }
                });
              </script>
            {% endif %}
        </form> 
    </main>
    <script>
        // Validação de Senhas
        const senhaInput = document.getElementById('senha');
        const confirmarSenhaInput = document.getElementById('confirmar_senha');
        const passwordMessage = document.getElementById('password-match-message');

        function checkPasswords() {
            if (senhaInput.value.length > 0 && confirmarSenhaInput.value.length > 0) {
                if (senhaInput.value !== confirmarSenhaInput.value) {
                    passwordMessage.textContent = "As senhas não coincidem!";
                    passwordMessage.classList.add('erro');
                    passwordMessage.classList.remove('sucesso');
                    confirmarSenhaInput.setCustomValidity('Senhas não coincidem');
                } else {
                    passwordMessage.textContent = "Senhas coincidem!";
                    passwordMessage.classList.add('sucesso');
                    passwordMessage.classList.remove('erro');
                    confirmarSenhaInput.setCustomValidity('');
                }
            } else {
                passwordMessage.textContent = "";
                confirmarSenhaInput.setCustomValidity('');
            }
        }

        senhaInput.addEventListener('keyup', checkPasswords);
        confirmarSenhaInput.addEventListener('keyup', checkPasswords);

        const emailInput = document.getElementById('email');
        const emailMessage = document.getElementById('email-validation-message');
        let emailTimeout;

        function validateEmail() {
            const email = emailInput.value;
            emailMessage.textContent = "";
            emailMessage.classList.remove('erro', 'sucesso');

            if (!email || !emailInput.checkValidity()) {
                return;
            }
            
            clearTimeout(emailTimeout);
            emailTimeout = setTimeout(() => {
                
                emailMessage.textContent = "Verificando email...";
                emailMessage.classList.add('loading');
                
                fetch("{{ url_for('cliente_bp.check_email') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: email })
                })
                .then(response => response.json())
                .then(data => {
                    emailMessage.classList.remove('loading');
                    emailMessage.textContent = ""; 
                    emailMessage.classList.remove('erro', 'sucesso');

                    if (data.available === false) {
                        emailMessage.textContent = data.message; 
                        emailMessage.classList.add('erro');
                        emailInput.setCustomValidity(data.message);
                    } else {
                        emailInput.setCustomValidity(''); 
                    }
                })
            }, 700);
        }

        emailInput.addEventListener('input', validateEmail);

        document.querySelector('form').addEventListener('submit', function(event) {
            checkPasswords();
        });
    </script>
</body>
</html>